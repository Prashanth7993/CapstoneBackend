# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger: none

resources:
- repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: 'dc77e625-549d-4539-8938-89bc530738a1'
  imageRepository: 'frontendfinalimage'
  containerRegistry: 'mysharedacr1234.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '1.0.0'

  # Agent VM image name
  #vmImageName: 'ubuntu-latest'

stages:
- stage: TestingStage
  displayName: Testing
  jobs:
  - job: Testing
    displayName: Testing
    pool:
      name: Default
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js 20'

    - script: |
        npm install
      displayName: 'Install Dependencies'

    # - script: |
    #     npm run test -- --watch=false --browsers=ChromeHeadless
    #   displayName: 'Run Unit Tests'

    - script: |
        echo "Installing Snyk CLI..."
        npm install -g snyk
      displayName: 'Install Snyk CLI'

    - script: |
        echo "Authenticating with Snyk..."
        snyk auth $(SNYK_TOKEN)
      env:
        SNYK_TOKEN: $(SNYK_TOKEN)
      displayName: 'Authenticate Snyk'

    - script: |
        snyk test --all-projects --severity-threshold=medium --json > snyk-report.json
        cat snyk-report.json
      displayName: 'Run Snyk Security Test'


- stage: Build
  displayName: Build and push stage
  jobs:
  - job: Build
    displayName: Build
    pool:
      name: Default
    steps:
    - task: Docker@2
      displayName: Build and push an image to container registry
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: $(dockerfilePath)
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)